<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs & Audit System - ZaloPay Phishing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ZaloPay Design System -->
    <link href="/css/zalopay-variables.css" rel="stylesheet">
    <link href="/css/zalopay-shared.css" rel="stylesheet">
    <link href="/css/zalopay-components.css" rel="stylesheet">
    <link href="/admin/css/zalopay-admin.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .log-entry {
            transition: all 0.2s;
        }
        .log-entry:hover {
            background-color: #f8f9fa;
        }
        .severity-critical {
            border-left: 4px solid #dc3545;
        }
        .severity-error {
            border-left: 4px solid #fd7e14;
        }
        .severity-warning {
            border-left: 4px solid #ffc107;
        }
        .severity-info {
            border-left: 4px solid #17a2b8;
        }
        .severity-debug {
            border-left: 4px solid #6c757d;
        }
        .category-badge {
            font-size: 0.75rem;
        }
        .action-type-badge {
            font-size: 0.8rem;
        }
        .log-details {
            max-height: 200px;
            overflow-y: auto;
        }
        .filter-panel {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .suspicious-activity {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .export-buttons {
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clipboard-list"></i> Activity Logs & Audit
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock"></i> <span id="last-update">Last update: --</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Total Events</h6>
                                <h3 id="total-events" class="mb-0">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-list fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Security Events</h6>
                                <h3 id="security-events" class="mb-0">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-shield-alt fa-2x text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Data Access</h6>
                                <h3 id="data-access-events" class="mb-0">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-database fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Suspicious</h6>
                                <h3 id="suspicious-activities" class="mb-0">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="row">
                <div class="col-md-2">
                    <label for="start-date" class="form-label">Start Date</label>
                    <input type="datetime-local" class="form-control" id="start-date">
                </div>
                <div class="col-md-2">
                    <label for="end-date" class="form-label">End Date</label>
                    <input type="datetime-local" class="form-control" id="end-date">
                </div>
                <div class="col-md-2">
                    <label for="action-type" class="form-label">Action Type</label>
                    <select class="form-select" id="action-type">
                        <option value="">All Actions</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                        <option value="victim_captured">Victim Captured</option>
                        <option value="campaign_created">Campaign Created</option>
                        <option value="gmail_access_success">Gmail Access</option>
                        <option value="beef_session_established">BeEF Session</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="severity" class="form-label">Severity</label>
                    <select class="form-select" id="severity">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="info">Info</option>
                        <option value="debug">Debug</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category">
                        <option value="">All Categories</option>
                        <option value="authentication">Authentication</option>
                        <option value="victim_management">Victim Management</option>
                        <option value="campaign_management">Campaign Management</option>
                        <option value="oauth_operations">OAuth Operations</option>
                        <option value="gmail_operations">Gmail Operations</option>
                        <option value="beef_operations">BeEF Operations</option>
                        <option value="security_events">Security Events</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <label for="search-query" class="form-label">Search Query</label>
                    <input type="text" class="form-control" id="search-query" placeholder="Search in logs...">
                </div>
                <div class="col-md-2">
                    <label for="admin-id" class="form-label">Admin ID</label>
                    <input type="text" class="form-control" id="admin-id" placeholder="Admin ID">
                </div>
                <div class="col-md-2">
                    <label for="victim-id" class="form-label">Victim ID</label>
                    <input type="text" class="form-control" id="victim-id" placeholder="Victim ID">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" onclick="searchLogs()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export and Actions -->
        <div class="export-buttons">
            <button class="btn btn-success" onclick="exportLogs('csv')">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
            <button class="btn btn-info" onclick="exportLogs('json')">
                <i class="fas fa-file-code"></i> Export JSON
            </button>
            <button class="btn btn-warning" onclick="generateComplianceReport()">
                <i class="fas fa-file-alt"></i> Generate Compliance Report
            </button>
            <button class="btn btn-danger" onclick="cleanupOldLogs()">
                <i class="fas fa-trash"></i> Cleanup Old Logs
            </button>
            <button class="btn btn-secondary" onclick="refreshLogs()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie"></i> Events by Category
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> Events by Severity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="severityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suspicious Activities -->
        <div class="row mb-4 hidden" id="suspicious-panel">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Suspicious Activities Detected
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="suspicious-activities-list">
                            <!-- Suspicious activities will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Logs Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Activity Logs
                        </h5>
                        <div>
                            <span class="badge bg-primary" id="logs-count">0 logs</span>
                            <span class="badge bg-secondary" id="logs-total">Total: 0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Action</th>
                                        <th>Admin</th>
                                        <th>Victim</th>
                                        <th>Campaign</th>
                                        <th>Severity</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-table">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading logs...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Logs pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be populated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal" title="Close">×</button>
                </div>
                <div class="modal-body">
                    <div id="log-details-content">
                        <!-- Log details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Report Modal -->
    <div class="modal fade" id="complianceReportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Compliance Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal" title="Close">×</button>
                </div>
                <div class="modal-body">
                    <div id="compliance-report-content">
                        <!-- Compliance report will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadComplianceReport()">
                        <i class="fas fa-download"></i> Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let categoryChart = null;
        let severityChart = null;
        let currentLogs = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let currentComplianceReport = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            setDefaultDates();
        });

        // Set default dates (last 30 days)
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('end-date').value = endDate.toISOString().slice(0, 16);
            document.getElementById('start-date').value = startDate.toISOString().slice(0, 16);
        }

        // Initialize charts
        function initializeCharts() {
            // Category chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Severity chart
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            severityChart = new Chart(severityCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Events',
                        data: [],
                        backgroundColor: [
                            '#dc3545', '#fd7e14', '#ffc107', '#17a2b8', '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/activity/dashboard?days=30');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data.dashboard_data);
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Update dashboard with data
        function updateDashboard(data) {
            // Update statistics
            const stats = data.statistics;
            document.getElementById('total-events').textContent = stats.total_events || 0;
            document.getElementById('security-events').textContent = stats.security_events || 0;
            document.getElementById('data-access-events').textContent = stats.data_access_events || 0;
            document.getElementById('suspicious-activities').textContent = data.suspicious_activities.length || 0;

            // Update charts
            updateCategoryChart(stats.events_by_category);
            updateSeverityChart(stats.events_by_severity);

            // Update suspicious activities
            updateSuspiciousActivities(data.suspicious_activities);

            // Update recent logs
            updateLogsTable(data.recent_logs);

            // Update last update time
            document.getElementById('last-update').textContent = 
                `Last update: ${new Date().toLocaleTimeString()}`;
        }

        // Update category chart
        function updateCategoryChart(categoryData) {
            if (!categoryChart || !categoryData) return;

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = data;
            categoryChart.update('none');
        }

        // Update severity chart
        function updateSeverityChart(severityData) {
            if (!severityChart || !severityData) return;

            const labels = Object.keys(severityData);
            const data = Object.values(severityData);

            severityChart.data.labels = labels;
            severityChart.data.datasets[0].data = data;
            severityChart.update('none');
        }

        // Update suspicious activities
        function updateSuspiciousActivities(activities) {
            const panel = document.getElementById('suspicious-panel');
            const list = document.getElementById('suspicious-activities-list');

            if (activities.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');
            list.innerHTML = activities.map(activity => `
                <div class="suspicious-activity">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ${activity.type.replace(/_/g, ' ').toUpperCase()}
                            </h6>
                            <p class="mb-1">${activity.description}</p>
                            <small class="text-muted">Count: ${activity.count}</small>
                        </div>
                        <span class="badge bg-${activity.severity === 'high' ? 'danger' : 'warning'}">
                            ${activity.severity.toUpperCase()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Update logs table
        function updateLogsTable(logs) {
            currentLogs = logs;
            const tbody = document.getElementById('logs-table');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No logs found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr class="log-entry severity-${log.severity}">
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="badge bg-primary action-type-badge">${log.action_type}</span>
                    </td>
                    <td>${log.admin_id || '-'}</td>
                    <td>${log.victim_id || '-'}</td>
                    <td>${log.campaign_id || '-'}</td>
                    <td>
                        <span class="badge bg-${getSeverityColor(log.severity)}">${log.severity.toUpperCase()}</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary category-badge">${log.category}</span>
                    </td>
                    <td>${log.description}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showLogDetails('${log.log_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('logs-count').textContent = `${logs.length} logs`;
        }

        // Get severity color
        function getSeverityColor(severity) {
            const colors = {
                'critical': 'danger',
                'error': 'warning',
                'warning': 'warning',
                'info': 'info',
                'debug': 'secondary'
            };
            return colors[severity] || 'secondary';
        }

        // Show log details
        function showLogDetails(logId) {
            const log = currentLogs.find(l => l.log_id === logId);
            if (!log) return;

            const content = document.getElementById('log-details-content');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Log ID:</strong></td><td>${log.log_id}</td></tr>
                            <tr><td><strong>Timestamp:</strong></td><td>${new Date(log.timestamp).toLocaleString()}</td></tr>
                            <tr><td><strong>Action Type:</strong></td><td>${log.action_type}</td></tr>
                            <tr><td><strong>Severity:</strong></td><td>${log.severity}</td></tr>
                            <tr><td><strong>Category:</strong></td><td>${log.category}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Context Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Admin ID:</strong></td><td>${log.admin_id || '-'}</td></tr>
                            <tr><td><strong>Victim ID:</strong></td><td>${log.victim_id || '-'}</td></tr>
                            <tr><td><strong>Campaign ID:</strong></td><td>${log.campaign_id || '-'}</td></tr>
                            <tr><td><strong>Session ID:</strong></td><td>${log.session_id || '-'}</td></tr>
                            <tr><td><strong>IP Address:</strong></td><td>${log.ip_address}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Description</h6>
                        <p>${log.description}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Old Values</h6>
                        <pre class="log-details">${JSON.stringify(log.old_values, null, 2)}</pre>
                    </div>
                    <div class="col-md-6">
                        <h6>New Values</h6>
                        <pre class="log-details">${JSON.stringify(log.new_values, null, 2)}</pre>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Details</h6>
                        <pre class="log-details">${JSON.stringify(log.details, null, 2)}</pre>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Tags</h6>
                        <div>${log.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join(' ')}</div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
            modal.show();
        }

        // Apply filters
        function applyFilters() {
            const filters = {
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
                action_type: document.getElementById('action-type').value,
                severity: document.getElementById('severity').value,
                category: document.getElementById('category').value,
                admin_id: document.getElementById('admin-id').value,
                victim_id: document.getElementById('victim-id').value
            };

            currentFilters = filters;
            loadFilteredLogs();
        }

        // Search logs
        function searchLogs() {
            const searchQuery = document.getElementById('search-query').value;
            if (!searchQuery.trim()) {
                alert('Please enter a search query');
                return;
            }

            loadSearchedLogs(searchQuery);
        }

        // Load filtered logs
        async function loadFilteredLogs() {
            try {
                const params = new URLSearchParams();
                Object.entries(currentFilters).forEach(([key, value]) => {
                    if (value) params.append(key, value);
                });

                const response = await fetch(`/api/admin/activity/logs?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    updateLogsTable(data.logs);
                } else {
                    throw new Error('Failed to load filtered logs');
                }
            } catch (error) {
                console.error('Error loading filtered logs:', error);
                alert('Error loading filtered logs');
            }
        }

        // Load searched logs
        async function loadSearchedLogs(searchQuery) {
            try {
                const response = await fetch('/api/admin/activity/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        search_query: searchQuery,
                        start_date: currentFilters.start_date,
                        end_date: currentFilters.end_date,
                        limit: 100
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateLogsTable(data.logs);
                } else {
                    throw new Error('Failed to search logs');
                }
            } catch (error) {
                console.error('Error searching logs:', error);
                alert('Error searching logs');
            }
        }

        // Export logs
        function exportLogs(format) {
            const params = new URLSearchParams();
            Object.entries(currentFilters).forEach(([key, value]) => {
                if (value) params.append(key, value);
            });

            window.open(`/api/admin/activity/export/${format}?${params}`, '_blank');
        }

        // Generate compliance report
        async function generateComplianceReport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            try {
                const response = await fetch('/api/admin/activity/compliance-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        report_type: 'compliance_audit',
                        start_date: startDate,
                        end_date: endDate,
                        generated_by: 'admin' // TODO: Get actual admin ID
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentComplianceReport = data.report;
                    showComplianceReport(data.report);
                } else {
                    throw new Error('Failed to generate compliance report');
                }
            } catch (error) {
                console.error('Error generating compliance report:', error);
                alert('Error generating compliance report');
            }
        }

        // Show compliance report
        function showComplianceReport(report) {
            const content = document.getElementById('compliance-report-content');
            content.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <h5>Compliance Report</h5>
                        <p><strong>Report ID:</strong> ${report.report_id}</p>
                        <p><strong>Period:</strong> ${new Date(report.start_date).toLocaleDateString()} - ${new Date(report.end_date).toLocaleDateString()}</p>
                        <p><strong>Generated:</strong> ${new Date(report.generated_at).toLocaleString()}</p>
                        <p><strong>Generated By:</strong> ${report.generated_by}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Summary Statistics</h6>
                        <ul>
                            <li>Total Events: ${report.total_events.toLocaleString()}</li>
                            <li>Security Events: ${report.security_events.toLocaleString()}</li>
                            <li>Data Access Events: ${report.data_access_events.toLocaleString()}</li>
                            <li>Admin Actions: ${report.admin_actions.toLocaleString()}</li>
                            <li>Suspicious Activities: ${report.suspicious_activities.toLocaleString()}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Events by Category</h6>
                        <ul>
                            ${Object.entries(report.events_by_category).map(([category, count]) => 
                                `<li>${category}: ${count.toLocaleString()}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Summary</h6>
                        <pre style="white-space: pre-wrap;">${report.summary}</pre>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Recommendations</h6>
                        <ul>
                            ${report.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('complianceReportModal'));
            modal.show();
        }

        // Download compliance report
        function downloadComplianceReport() {
            if (!currentComplianceReport) return;
            
            const dataStr = JSON.stringify(currentComplianceReport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `compliance_report_${currentComplianceReport.report_id}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Cleanup old logs
        async function cleanupOldLogs() {
            if (!confirm('Are you sure you want to cleanup old logs? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/activity/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        days_to_keep: 90
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Cleaned up ${data.deleted_count} old logs`);
                    loadDashboardData();
                } else {
                    throw new Error('Failed to cleanup old logs');
                }
            } catch (error) {
                console.error('Error cleaning up old logs:', error);
                alert('Error cleaning up old logs');
            }
        }

        // Refresh logs
        function refreshLogs() {
            loadDashboardData();
        }
    </script>
</body>
</html>