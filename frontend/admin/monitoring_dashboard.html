<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring Dashboard - ZaloPay Phishing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ZaloPay Design System -->
    <link href="/css/zalopay-variables.css" rel="stylesheet">
    <link href="/css/zalopay-shared.css" rel="stylesheet">
    <link href="/css/zalopay-components.css" rel="stylesheet">
    <link href="/admin/css/zalopay-admin.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="monitoring_dashboard.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .alert-critical {
            border-left: 4px solid #dc3545;
        }
        .alert-warning {
            border-left: 4px solid #ffc107;
        }
        .alert-info {
            border-left: 4px solid #17a2b8;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #28a745;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-critical {
            background-color: #dc3545;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .real-time-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> System Monitoring
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="connection-status" class="status-indicator status-healthy"></span>
                    <span id="last-update">Last update: --</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">CPU Usage</h6>
                                <h3 id="cpu-usage" class="mb-0">--%</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-microchip fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="progress mt-2 monitoring-progress">
                            <div id="cpu-progress" class="progress-bar" role="progressbar" aria-label="CPU Usage"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Memory Usage</h6>
                                <h3 id="memory-usage" class="mb-0">--%</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-memory fa-2x text-info"></i>
                            </div>
                        </div>
                        <div class="progress mt-2 monitoring-progress">
                            <div id="memory-progress" class="progress-bar" role="progressbar" aria-label="Memory Usage"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Disk Usage</h6>
                                <h3 id="disk-usage" class="mb-0">--%</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-hdd fa-2x text-warning"></i>
                            </div>
                        </div>
                        <div class="progress mt-2 monitoring-progress">
                            <div id="disk-progress" class="progress-bar" role="progressbar" aria-label="Disk Usage"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Active Alerts</h6>
                                <h3 id="active-alerts" class="mb-0">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                        </div>
                        <small class="text-muted" id="alert-summary">--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area"></i> System Performance Trends
                            <span class="real-time-indicator float-end">
                                <i class="fas fa-circle text-success"></i> Live
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie"></i> API Response Times
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="apiChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts and Status Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bell"></i> Recent Alerts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="alerts-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading alerts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-server"></i> System Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Rules Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs"></i> Alert Rules Management
                        </h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateRuleModal()">
                            <i class="fas fa-plus"></i> Create Rule
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Metric</th>
                                        <th>Condition</th>
                                        <th>Threshold</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="alert-rules-table">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading rules...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Alert Rule Modal -->
    <div class="modal fade" id="createRuleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Alert Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRuleForm">
                        <div class="mb-3">
                            <label for="ruleName" class="form-label">Rule Name</label>
                            <input type="text" class="form-control" id="ruleName" required>
                        </div>
                        <div class="mb-3">
                            <label for="metricName" class="form-label">Metric Name</label>
                            <select class="form-select" id="metricName" required>
                                <option value="system_cpu">System CPU</option>
                                <option value="system_memory">System Memory</option>
                                <option value="system_disk">System Disk</option>
                                <option value="api_performance">API Performance</option>
                                <option value="database_performance">Database Performance</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="condition" class="form-label">Condition</label>
                                    <select class="form-select" id="condition" required>
                                        <option value=">">Greater than</option>
                                        <option value="<">Less than</option>
                                        <option value=">=">Greater than or equal</option>
                                        <option value="<=">Less than or equal</option>
                                        <option value="==">Equal to</option>
                                        <option value="!=">Not equal to</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="threshold" class="form-label">Threshold</label>
                                    <input type="number" class="form-control" id="threshold" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="duration" class="form-label">Duration (seconds)</label>
                                    <input type="number" class="form-control" id="duration" value="300" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="severity" class="form-label">Severity</label>
                            <select class="form-select" id="severity" required>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createAlertRule()">Create Rule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let performanceChart = null;
        let apiChart = null;
        let updateInterval = null;
        let isConnected = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            startAutoUpdate();
        });

        // Initialize charts
        function initializeCharts() {
            // Performance chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Memory %',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Disk %',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // API chart
            const apiCtx = document.getElementById('apiChart').getContext('2d');
            apiChart = new Chart(apiCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Fast (<1s)', 'Medium (1-3s)', 'Slow (>3s)'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/monitoring/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data.data);
                    isConnected = true;
                    updateConnectionStatus(true);
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                isConnected = false;
                updateConnectionStatus(false);
            }
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update system metrics
            if (data.system_metrics) {
                updateSystemMetrics(data.system_metrics);
            }

            // Update API metrics
            if (data.api_metrics) {
                updateApiMetrics(data.api_metrics);
            }

            // Update alerts
            if (data.alert_summary) {
                updateAlerts(data.alert_summary, data.recent_alerts);
            }

            // Update system status
            updateSystemStatus(data.monitoring_status);

            // Update charts
            updatePerformanceChart(data.system_metrics);
            updateApiChart(data.latency_stats);

            // Update last update time
            document.getElementById('last-update').textContent = 
                `Last update: ${new Date().toLocaleTimeString()}`;
        }

        // Update system metrics
        function updateSystemMetrics(metrics) {
            // CPU
            const cpuUsage = metrics.system_cpu?.usage_percent || 0;
            document.getElementById('cpu-usage').textContent = `${cpuUsage.toFixed(1)}%`;
            document.getElementById('cpu-progress').style.width = `${cpuUsage}%`;
            document.getElementById('cpu-progress').className = 
                `progress-bar ${cpuUsage > 80 ? 'bg-danger' : cpuUsage > 60 ? 'bg-warning' : 'bg-success'}`;

            // Memory
            const memoryUsage = metrics.system_memory?.usage_percent || 0;
            document.getElementById('memory-usage').textContent = `${memoryUsage.toFixed(1)}%`;
            document.getElementById('memory-progress').style.width = `${memoryUsage}%`;
            document.getElementById('memory-progress').className = 
                `progress-bar ${memoryUsage > 85 ? 'bg-danger' : memoryUsage > 70 ? 'bg-warning' : 'bg-success'}`;

            // Disk
            const diskUsage = metrics.system_disk?.usage_percent || 0;
            document.getElementById('disk-usage').textContent = `${diskUsage.toFixed(1)}%`;
            document.getElementById('disk-progress').style.width = `${diskUsage}%`;
            document.getElementById('disk-progress').className = 
                `progress-bar ${diskUsage > 90 ? 'bg-danger' : diskUsage > 80 ? 'bg-warning' : 'bg-success'}`;
        }

        // Update API metrics
        function updateApiMetrics(metrics) {
            // This would update API-specific metrics
            console.log('API metrics:', metrics);
        }

        // Update alerts
        function updateAlerts(summary, recentAlerts) {
            document.getElementById('active-alerts').textContent = summary.active_alerts || 0;
            document.getElementById('alert-summary').textContent = 
                `${summary.total_alerts_24h || 0} alerts in last 24h`;

            // Update alerts list
            const alertsList = document.getElementById('alerts-list');
            if (recentAlerts && recentAlerts.length > 0) {
                alertsList.innerHTML = recentAlerts.map(alert => `
                    <div class="alert alert-${alert.severity === 'critical' ? 'danger' : 
                        alert.severity === 'warning' ? 'warning' : 'info'} alert-${alert.severity}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${alert.severity.toUpperCase()}</strong> - ${alert.message}
                            </div>
                            <small>${new Date(alert.timestamp).toLocaleTimeString()}</small>
                        </div>
                    </div>
                `).join('');
            } else {
                alertsList.innerHTML = '<div class="text-center text-muted">No recent alerts</div>';
            }
        }

        // Update system status
        function updateSystemStatus(status) {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        Monitoring Status
                        <span class="badge ${status.active ? 'bg-success' : 'bg-secondary'}">
                            ${status.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        InfluxDB Connection
                        <span class="badge ${status.influxdb_connected ? 'bg-success' : 'bg-danger'}">
                            ${status.influxdb_connected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        Metrics Buffer
                        <span class="badge bg-info">${status.metrics_buffer_size || 0}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        Alert Rules
                        <span class="badge bg-primary">${status.total_alert_rules || 0}</span>
                    </div>
                </div>
            `;
        }

        // Update performance chart
        function updatePerformanceChart(metrics) {
            if (!performanceChart) return;

            const now = new Date().toLocaleTimeString();
            const cpuValue = metrics.system_cpu?.usage_percent || 0;
            const memoryValue = metrics.system_memory?.usage_percent || 0;
            const diskValue = metrics.system_disk?.usage_percent || 0;

            // Add new data point
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(cpuValue);
            performanceChart.data.datasets[1].data.push(memoryValue);
            performanceChart.data.datasets[2].data.push(diskValue);

            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }

            performanceChart.update('none');
        }

        // Update API chart
        function updateApiChart(latencyStats) {
            if (!apiChart) return;

            // Calculate distribution from latency stats
            let fast = 0, medium = 0, slow = 0;
            
            Object.values(latencyStats).forEach(stats => {
                const avg = stats.avg || 0;
                if (avg < 1) fast++;
                else if (avg < 3) medium++;
                else slow++;
            });

            apiChart.data.datasets[0].data = [fast, medium, slow];
            apiChart.update('none');
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connection-status');
            if (connected) {
                statusIndicator.className = 'status-indicator status-healthy';
            } else {
                statusIndicator.className = 'status-indicator status-critical';
            }
        }

        // Start auto-update
        function startAutoUpdate() {
            updateInterval = setInterval(loadDashboardData, 30000); // Update every 30 seconds
        }

        // Stop auto-update
        function stopAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Show create rule modal
        function showCreateRuleModal() {
            const modal = new bootstrap.Modal(document.getElementById('createRuleModal'));
            modal.show();
        }

        // Create alert rule
        async function createAlertRule() {
            const form = document.getElementById('createRuleForm');
            const formData = new FormData(form);
            
            const ruleData = {
                name: document.getElementById('ruleName').value,
                metric_name: document.getElementById('metricName').value,
                condition: document.getElementById('condition').value,
                threshold: parseFloat(document.getElementById('threshold').value),
                duration: parseInt(document.getElementById('duration').value),
                severity: document.getElementById('severity').value,
                description: document.getElementById('description').value,
                notification_channels: ['email', 'webhook']
            };

            try {
                const response = await fetch('/api/monitoring/alerts/rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ruleData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Alert rule created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createRuleModal')).hide();
                    form.reset();
                    loadAlertRules();
                } else {
                    alert('Failed to create alert rule: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating alert rule:', error);
                alert('Error creating alert rule');
            }
        }

        // Load alert rules
        async function loadAlertRules() {
            try {
                const response = await fetch('/api/monitoring/alerts/rules');
                const data = await response.json();
                
                if (data.success) {
                    updateAlertRulesTable(data.rules);
                }
            } catch (error) {
                console.error('Error loading alert rules:', error);
            }
        }

        // Update alert rules table
        function updateAlertRulesTable(rules) {
            const tbody = document.getElementById('alert-rules-table');
            
            if (rules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No alert rules found</td></tr>';
                return;
            }

            tbody.innerHTML = rules.map(rule => `
                <tr>
                    <td>${rule.name}</td>
                    <td>${rule.metric_name}</td>
                    <td>${rule.condition}</td>
                    <td>${rule.threshold}</td>
                    <td>
                        <span class="badge bg-${rule.severity === 'critical' ? 'danger' : 
                            rule.severity === 'warning' ? 'warning' : 
                            rule.severity === 'error' ? 'danger' : 'info'}">
                            ${rule.severity}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${rule.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${rule.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editRule('${rule.rule_id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('${rule.rule_id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Edit rule
        function editRule(ruleId) {
            // TODO: Implement edit functionality
            alert('Edit functionality not implemented yet');
        }

        // Delete rule
        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this alert rule?')) {
                return;
            }

            try {
                const response = await fetch(`/api/monitoring/alerts/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Alert rule deleted successfully!');
                    loadAlertRules();
                } else {
                    alert('Failed to delete alert rule');
                }
            } catch (error) {
                console.error('Error deleting alert rule:', error);
                alert('Error deleting alert rule');
            }
        }

        // Load alert rules on page load
        loadAlertRules();

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoUpdate();
        });
    </script>
</body>
</html>
