<!DOCTYPE html>
<html lang="vi" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Extraction Progress - ZaloPay Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ZaloPay Design System -->
    <link href="/css/zalopay-variables.css" rel="stylesheet">
    <link href="/css/zalopay-shared.css" rel="stylesheet">
    <link href="/css/zalopay-components.css" rel="stylesheet">
    <link href="/admin/css/zalopay-admin.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/gmail-responsive.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .sidebar {
            width: 260px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-content {
            flex: 1;
            background-color: #f8f9fa;
        }
        .extraction-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .progress {
            height: 10px;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        .log-info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .log-success { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .log-warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .log-error { background-color: #ffebee; border-left: 4px solid #f44336; }
        .metrics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .control-btn {
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar d-flex flex-column p-3">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <img src="#" alt="ZaloPay Logo" class="me-2 sidebar-logo-img">
                <span class="fs-4">ZaloPay</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="index.html" class="nav-link text-white">
                        <i class="fa-solid fa-house me-2"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="gmail_access.html" class="nav-link text-white">
                        <i class="fa-solid fa-envelope me-2"></i>
                        <span>Gmail Access</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="gmail_extraction_progress.html" class="nav-link text-white active">
                        <i class="fa-solid fa-cog me-2"></i>
                        <span>Extraction Progress</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="beef_dashboard.html" class="nav-link text-white">
                        <i class="fa-solid fa-bug me-2"></i>
                        <span>BeEF Control</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content p-4">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Gmail Extraction Progress</h1>
                    <p class="text-muted">Theo dõi tiến trình khai thác dữ liệu Gmail theo thời gian thực</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Làm mới
                    </button>
                    <button class="btn btn-secondary" onclick="clearLogs()">
                        <i class="fas fa-trash me-2"></i>Xóa logs
                    </button>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-gamepad me-2"></i>Bảng điều khiển khai thác
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100" onclick="startGlobalExtraction()">
                                        <i class="fas fa-play me-2"></i>Bắt đầu khai thác tất cả
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-warning w-100" onclick="pauseAllExtractions()">
                                        <i class="fas fa-pause me-2"></i>Tạm dừng tất cả
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-info w-100" onclick="resumeAllExtractions()">
                                        <i class="fas fa-play-circle me-2"></i>Tiếp tục tất cả
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-danger w-100" onclick="cancelAllExtractions()">
                                        <i class="fas fa-stop me-2"></i>Dừng tất cả
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card metrics-card shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-uppercase mb-1">
                                        Tổng tiến trình
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold">
                                        <span id="overallProgress">0%</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chart-line fa-2x text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Emails/giây
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <span id="emailsPerSecond">0</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Tổng emails đã xử lý
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <span id="totalProcessed">0</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-envelope fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Thời gian còn lại (ước tính)
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <span id="estimatedTime">--:--:--</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Active Extractions -->
                <div class="col-lg-8 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-tasks me-2"></i>Các tiến trình đang hoạt động
                            </h6>
                            <div class="d-flex">
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                    <label class="form-check-label" for="autoScrollToggle">
                                        Tự động cuộn
                                    </label>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleDetails()">
                                    <i class="fas fa-expand-arrows-alt me-1"></i>Chi tiết
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="extraction-list" id="extractionList">
                                <!-- Active extractions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-chart-area me-2"></i>Hiệu suất theo thời gian thực
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Logs -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-terminal me-2"></i>Logs thời gian thực
                            </h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-filter me-1"></i>Lọc logs
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="filterLogs('all')">Tất cả</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterLogs('info')">Thông tin</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterLogs('success')">Thành công</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterLogs('warning')">Cảnh báo</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterLogs('error')">Lỗi</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="logs-container" id="logsContainer" style="max-height: 400px; overflow-y: auto;">
                                <!-- Real-time logs will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Extraction Details Modal -->
    <div class="modal fade" id="extractionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết tiến trình khai thác</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Thông tin cơ bản</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td id="detailEmail">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Trạng thái:</strong></td>
                                    <td id="detailStatus">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Tiến trình:</strong></td>
                                    <td id="detailProgress">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Bắt đầu lúc:</strong></td>
                                    <td id="detailStartTime">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Thời gian chạy:</strong></td>
                                    <td id="detailDuration">-</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Thống kê dữ liệu</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Emails đã xử lý:</strong></td>
                                    <td id="detailEmailsProcessed">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Liên hệ tìm thấy:</strong></td>
                                    <td id="detailContactsFound">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Tệp đính kèm:</strong></td>
                                    <td id="detailAttachmentsFound">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Dung lượng dữ liệu:</strong></td>
                                    <td id="detailDataSize">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Logs chi tiết</h6>
                        <div id="detailLogs" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">
                            <!-- Detailed logs will be shown here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="stopExtractionBtn">Dừng khai thác</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="js/gmail-websocket.js"></script>
    <script src="js/gmail-localization.js"></script>

    <script>
        let ws = null;
        let extractionData = [];
        let logs = [];
        let performanceData = [];
        let performanceChart = null;
        let autoScroll = true;
        let currentFilter = 'all';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadExtractionData();
            initializePerformanceChart();
            setupEventListeners();
            startAutoRefresh();
        });

        function setupEventListeners() {
            document.getElementById('autoScrollToggle').addEventListener('change', function() {
                autoScroll = this.checked;
            });
        }

        function initializeWebSocket() {
            // WebSocket is now handled by the global GmailWebSocketManager
            // Set up event listeners for this interface
            gmailWS.on('extraction_progress', updateExtractionProgress);
            gmailWS.on('extraction_completed', handleExtractionCompleted);
            gmailWS.on('extraction_failed', handleExtractionFailed);
            gmailWS.on('extraction_paused', handleExtractionPaused);
            gmailWS.on('extraction_cancelled', handleExtractionCancelled);
            gmailWS.on('performance_metrics', updatePerformanceMetrics);
            gmailWS.on('system_notification', handleSystemNotification);

            // Request current extraction data
            sendGmailWSMessage({
                type: 'request_current_extractions',
                interface: 'extraction'
            });
        }

        function handleExtractionPaused(data) {
            toastr.info(`Tạm dừng khai thác: ${data.email}`);
            loadExtractionData();
        }

        function handleExtractionCancelled(data) {
            toastr.warning(`Hủy khai thác: ${data.email}`);
            loadExtractionData();
        }

        function handleSystemNotification(data) {
            if (data.level === 'error') {
                toastr.error(data.message);
            } else if (data.level === 'warning') {
                toastr.warning(data.message);
            } else {
                toastr.info(data.message);
            }
        }

        async function loadExtractionData() {
            try {
                const response = await fetch('/api/admin/gmail/extractions/active', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    extractionData = result.data;
                    renderExtractionList();
                    updateOverallMetrics();
                } else {
                    throw new Error(result.message || 'Không thể tải dữ liệu khai thác');
                }
            } catch (error) {
                console.error('Error loading extraction data:', error);
                toastr.error('Không thể tải dữ liệu khai thác: ' + error.message);
            }
        }

        function renderExtractionList() {
            const container = document.getElementById('extractionList');

            if (extractionData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Không có tiến trình khai thác nào đang hoạt động</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            extractionData.forEach(extraction => {
                const card = createExtractionCard(extraction);
                container.appendChild(card);
            });
        }

        function createExtractionCard(extraction) {
            const card = document.createElement('div');
            card.className = 'extraction-card p-3';

            const statusClass = getStatusClass(extraction.status);
            const progressPercent = extraction.progress || 0;

            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">${extraction.email}</h6>
                            <span class="badge ${statusClass}">${getStatusText(extraction.status)}</span>
                        </div>
                        <div class="text-muted small">
                            Bắt đầu: ${formatDate(extraction.start_time)} |
                            Thời gian chạy: ${formatDuration(extraction.duration)}
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="viewDetails('${extraction.id}')">
                                <i class="fas fa-info-circle me-2"></i>Xem chi tiết
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="pauseExtraction('${extraction.id}')">
                                <i class="fas fa-pause me-2"></i>Tạm dừng
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="cancelExtraction('${extraction.id}')">
                                <i class="fas fa-stop me-2"></i>Dừng
                            </a></li>
                        </ul>
                    </div>
                </div>

                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Tiến trình: ${progressPercent}%</span>
                        <span class="small">${extraction.current_step || 'Đang khởi tạo'}</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated ${getProgressBarClass(extraction.status)}"
                             style="width: ${progressPercent}%"></div>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="col-3">
                        <div class="small text-muted">Emails</div>
                        <div class="fw-bold">${extraction.stats?.emails_processed || 0}</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">Liên hệ</div>
                        <div class="fw-bold">${extraction.stats?.contacts_found || 0}</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">Tệp đính kèm</div>
                        <div class="fw-bold">${extraction.stats?.attachments_found || 0}</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">Tốc độ</div>
                        <div class="fw-bold">${extraction.stats?.emails_per_second || 0}/giây</div>
                    </div>
                </div>
            `;

            return card;
        }

        function initializePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Emails/giây',
                        data: [],
                        borderColor: '#0068FF',
                        backgroundColor: 'rgba(0, 104, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        }

        function updatePerformanceChart() {
            if (performanceData.length > 20) {
                performanceData = performanceData.slice(-20);
            }

            performanceChart.data.labels = performanceData.map(d => moment(d.timestamp).format('HH:mm:ss'));
            performanceChart.data.datasets[0].data = performanceData.map(d => d.emails_per_second);
            performanceChart.update('none');
        }

        function addLogEntry(logData) {
            logs.unshift(logData);

            if (logs.length > 1000) {
                logs = logs.slice(0, 1000);
            }

            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            const filteredLogs = currentFilter === 'all' ? logs : logs.filter(log => log.level === currentFilter);

            container.innerHTML = '';

            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <p>Không có logs nào phù hợp với bộ lọc</p>
                    </div>
                `;
                return;
            }

            filteredLogs.forEach(log => {
                const logEntry = createLogEntry(log);
                container.appendChild(logEntry);
            });

            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function createLogEntry(log) {
            const div = document.createElement('div');
            div.className = `log-entry log-${log.level}`;

            const timestamp = moment(log.timestamp).format('HH:mm:ss');
            const levelIcon = getLogLevelIcon(log.level);

            div.innerHTML = `
                <div class="d-flex">
                    <small class="text-muted me-2" style="min-width: 80px;">${timestamp}</small>
                    <span class="me-2">${levelIcon}</span>
                    <span class="flex-grow-1">${log.message}</span>
                </div>
            `;

            return div;
        }

        function filterLogs(level) {
            currentFilter = level;
            renderLogs();
        }

        function updateExtractionProgress(data) {
            const extraction = extractionData.find(e => e.id === data.extraction_id);
            if (extraction) {
                Object.assign(extraction, data);
                renderExtractionList();
                updateOverallMetrics();
            }
        }

        function handleExtractionCompleted(data) {
            toastr.success(`Hoàn thành khai thác Gmail: ${data.email}`);
            loadExtractionData(); // Refresh the list
        }

        function handleExtractionFailed(data) {
            toastr.error(`Thất bại khai thác Gmail: ${data.email} - ${data.error}`);
            loadExtractionData(); // Refresh the list
        }

        function updatePerformanceMetrics(data) {
            performanceData.push({
                timestamp: new Date(),
                emails_per_second: data.emails_per_second,
                total_processed: data.total_processed
            });

            document.getElementById('emailsPerSecond').textContent = data.emails_per_second;
            document.getElementById('totalProcessed').textContent = data.total_processed;
            document.getElementById('estimatedTime').textContent = data.estimated_time_remaining;

            updatePerformanceChart();
        }

        function updateOverallMetrics() {
            if (extractionData.length === 0) {
                document.getElementById('overallProgress').textContent = '0%';
                return;
            }

            const totalProgress = extractionData.reduce((sum, ext) => sum + (ext.progress || 0), 0);
            const averageProgress = Math.round(totalProgress / extractionData.length);

            document.getElementById('overallProgress').textContent = `${averageProgress}%`;
        }

        function startAutoRefresh() {
            setInterval(() => {
                if (extractionData.length > 0) {
                    loadExtractionData();
                }
            }, 5000);
        }

        // Control functions
        async function startGlobalExtraction() {
            if (!confirm('Bạn có chắc chắn muốn bắt đầu khai thác tất cả tài khoản Gmail?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/gmail/extract-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success('Đã bắt đầu khai thác tất cả tài khoản Gmail');
                    loadExtractionData();
                } else {
                    toastr.error('Không thể bắt đầu khai thác: ' + result.message);
                }
            } catch (error) {
                console.error('Error starting global extraction:', error);
                toastr.error('Lỗi khi bắt đầu khai thác hàng loạt');
            }
        }

        async function pauseAllExtractions() {
            try {
                const response = await fetch('/api/admin/gmail/extractions/pause-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    toastr.info('Đã tạm dừng tất cả tiến trình khai thác');
                    loadExtractionData();
                } else {
                    toastr.error('Không thể tạm dừng: ' + result.message);
                }
            } catch (error) {
                console.error('Error pausing all extractions:', error);
                toastr.error('Lỗi khi tạm dừng tất cả tiến trình');
            }
        }

        async function resumeAllExtractions() {
            try {
                const response = await fetch('/api/admin/gmail/extractions/resume-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    toastr.info('Đã tiếp tục tất cả tiến trình khai thác');
                    loadExtractionData();
                } else {
                    toastr.error('Không thể tiếp tục: ' + result.message);
                }
            } catch (error) {
                console.error('Error resuming all extractions:', error);
                toastr.error('Lỗi khi tiếp tục tất cả tiến trình');
            }
        }

        async function cancelAllExtractions() {
            if (!confirm('Bạn có chắc chắn muốn dừng tất cả tiến trình khai thác?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/gmail/extractions/cancel-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    toastr.warning('Đã dừng tất cả tiến trình khai thác');
                    loadExtractionData();
                } else {
                    toastr.error('Không thể dừng: ' + result.message);
                }
            } catch (error) {
                console.error('Error canceling all extractions:', error);
                toastr.error('Lỗi khi dừng tất cả tiến trình');
            }
        }

        function pauseExtraction(extractionId) {
            // Implement pause functionality
            alert('Chức năng tạm dừng sẽ được triển khai');
        }

        function cancelExtraction(extractionId) {
            if (confirm('Bạn có chắc chắn muốn dừng tiến trình khai thác này?')) {
                // Implement cancel functionality
                alert('Chức năng dừng sẽ được triển khai');
            }
        }

        function viewDetails(extractionId) {
            const extraction = extractionData.find(e => e.id === extractionId);
            if (extraction) {
                // Show details modal
                alert('Chức năng xem chi tiết sẽ được triển khai');
            }
        }

        function refreshData() {
            loadExtractionData();
        }

        function clearLogs() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả logs?')) {
                logs = [];
                renderLogs();
                toastr.info('Đã xóa tất cả logs');
            }
        }

        function toggleDetails() {
            // Toggle detailed view
            alert('Chức năng chuyển đổi chế độ chi tiết sẽ được triển khai');
        }

        // Utility functions
        function getStatusClass(status) {
            switch(status) {
                case 'in_progress': return 'bg-info';
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'paused': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getProgressBarClass(status) {
            switch(status) {
                case 'in_progress': return 'bg-info';
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'paused': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'in_progress': return 'Đang thực hiện';
                case 'completed': return 'Hoàn thành';
                case 'failed': return 'Thất bại';
                case 'paused': return 'Tạm dừng';
                default: return 'Không xác định';
            }
        }

        function getLogLevelIcon(level) {
            switch(level) {
                case 'info': return '<i class="fas fa-info-circle text-info"></i>';
                case 'success': return '<i class="fas fa-check-circle text-success"></i>';
                case 'warning': return '<i class="fas fa-exclamation-triangle text-warning"></i>';
                case 'error': return '<i class="fas fa-times-circle text-danger"></i>';
                default: return '<i class="fas fa-circle text-muted"></i>';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDuration(seconds) {
            if (!seconds) return 'N/A';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
    </script>
</body>
</html>